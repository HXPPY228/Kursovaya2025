using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using lab2;
using lab3;

namespace ui
{
    public static class GameState
    {
        public static Player Player { get; set; }
        public static GameWindow Game { get; set; }
        public static StoryProgress StoryProgress { get; set; }
        public static Enemy CurrentEnemy { get; set; }
        public static bool IsStoryBattle { get; set; }
        public static Shop Shop { get; set; }
        public static List<(string Text, string ImagePath)> StoryScenes { get; private set; }
        public static int CurrentSceneIndex { get; set; } = 0;
        public static void InitializeStory()
        {
            var bases = new[]
            {
                "s1","s2","s3","s4","s5","s6","s7.png","s8.png","s9.png","s10","s11",
                "",
                "s12.png","s13.png", "s14.png", "s15", "s16", "s17", "s18.png"
            };

            var textsM = new[]
            {
                "Ночь опустилась на разрушенные стены Стародечно, и холодный ветер напомнил тебе о потерянном доме. (Нажмите на текст для продолжения)",
                "Ты — бывший страж этого города, когда-то стоявший на страже порядка и защищавший своих сограждан.",
                "Но одна ошибка — и ты повернул спину своим идеалам, поддавшись соблазну лёгкой наживы.",
                "Вместе с бандой преступников ты разграбил зимний склад провианта.",
                "Но, вскоре, твой предательский поступок вскрылся.",
                "Безоружный, без имени и без крыши над головой, ты был изгнан за стены Стародечно навсегда.",
                "Прошло несколько месяцев, пока слухи о новой угрозе не достигли Совета Старейшин.",
                "Лидер банды, которому ты когда-то помог, теперь держит в страхе весь регион: его мародёры грабят деревни, а разбойники наводят ужас на торговые пути.",
                "Совет предлагает тебе шанс на искупление: устранить троих его людей, контролирующих разные территории, и самого главаря Гаррета «Когтя» Вейла",
                "Только после этой миссии твоё имя сможет быть возвращено, а путь домой — открыт.",
                "Готов ли ты принять вызов и очистить своё прошлое кровью врагов?",
                "(Нажмите на текст для продолжения)", 
                "Ты возвращаешься в Стародечно, пройдя через ворота, покрытые барельефами павших героев.", 
                "Город, где когда‑то ты был стражем, встретил тебя смешанными чувствами: одни жители с улыбкой провожают взглядом твой путь, другие настороженно отворачиваются, ещё помня твое предательство.",
                "На главной площади, у трона Совета старейшин, ты предстаёшь перед теми, кому служил когда‑то. Старейшины, покрытые седыми волосами и годами труда, встают вслух:",
                "«Ты очистил свою вину кровью врага и доказал верность нашим идеалам. Принимай этот меч и почётную мантию — и стань новым капитаном стражи Стародечно. Пусть твой голос вновь направляет порядок, а рука твоя защищает народ.»",
                "В твоих руках — символ власти и доверия. Мантия цвета рассвета ложится на плечи, а меч — на пояс.",
                "Под аплодисменты и благословение горожан ты осознаёшь: путь искупления завершён, имя твоё очищено, и впереди открываются новые страницы истории Стародечно — уже написанные твоей честью.",
                "(Нажмите на текст для выхода из игры)"

            };

            var textsW = new[]
            {
                "Ночь опустилась на разрушенные стены Стародечно, и холодный ветер напомнил тебе о потерянном доме. (Нажмите на текст для продолжения)",
                "Ты — бывшая стражница этого города, когда-то стоявшая на страже порядка и защищавшая своих сограждан.",
                "Но одна ошибка — и ты повернула спину своим идеалам, поддавшись соблазну лёгкой наживы.",
                "Вместе с бандой преступников ты разграбила зимний склад провианта.",
                "Но, вскоре, твой предательский поступок вскрылся.",
                "Безоружная, без имени и без крыши над головой, ты была изгнана за стены Стародечно навсегда.",
                "Прошло несколько месяцев, пока слухи о новой угрозе не достигли Совета Старейшин.",
                "Лидер банды, которому ты когда-то помогла, теперь держит в страхе весь регион: его мародёры грабят деревни, а разбойники наводят ужас на торговые пути.",
                "Совет предлагает тебе шанс на искупление: устранить троих его людей, контролирующих разные территории, и самого главаря Гаррета «Когтя» Вейла",
                "Только после этой миссии твоё имя сможет быть возвращено, а путь домой — открыт.",
                "Готова ли ты принять вызов и очистить своё прошлое кровью врагов?",
                "(Нажмите на текст для продолжения)", 
                "Ты возвращаешься в Стародечно, пройдя через ворота, покрытые барельефами павших героев.",
                "Город, где когда‑то ты была стражем, встретил тебя смешанными чувствами: одни жители с улыбкой провожают взглядом твой путь, другие настороженно отворачиваются, ещё помня твое предательство.",
                "На главной площади, у трона Совета старейшин, ты предстаёшь перед теми, кому служила когда‑то. Старейшины, покрытые седыми волосами и годами труда, встают вслух:",
                "«Ты очистила свою вину кровью врага и доказала верность нашим идеалам. Принимай этот меч и почётную мантию — и стань новым капитаном стражи Стародечно. Пусть твой голос вновь направляет порядок, а рука твоя защищает народ.»",
                "В твоих руках — символ власти и доверия. Мантия цвета рассвета ложится на плечи, а меч — на пояс.",
                "Под аплодисменты и благословение горожан ты осознаёшь: путь искупления завершён, имя твоё очищено, и впереди открываются новые страницы истории Стародечно — уже написанные твоей честью.",
                "(Нажмите на текст для выхода из игры)"
            };

            var texts = Player.Gender ? textsM : textsW;

            StoryScenes = new List<(string, string)>();
            for (int i = 0; i < bases.Length; i++)
            {
                string img = ResolveImage(bases[i]);
                StoryScenes.Add((texts[i], img));
            }

            CurrentSceneIndex = 0;
        }
        private static string ResolveImage(string baseName)
        {
            if (string.IsNullOrWhiteSpace(baseName))
                return string.Empty;

            if (baseName.EndsWith(".png", StringComparison.OrdinalIgnoreCase))
                return baseName;

            if (baseName.StartsWith("s", StringComparison.OrdinalIgnoreCase)
                && int.TryParse(baseName.Substring(1), out int sceneNumber))
            {
                var suffix = Player.Gender ? "m" : "w";
                return $"{baseName}{suffix}.png";
            }

            return $"{baseName}.png";
        }

        public static GameSaveData CreateSaveData()
        {
            return new GameSaveData
            {
                Player = Player,
                StoryProgress = StoryProgress,
                Shop = Shop,
                StoryScenes = StoryScenes,
                CurrentSceneIndex = CurrentSceneIndex
            };
        }

        public static void LoadSaveData(GameSaveData saveData)
        {
            Player = saveData.Player;
            StoryProgress = saveData.StoryProgress;
            Shop = saveData.Shop;
            StoryScenes = saveData.StoryScenes;
            CurrentSceneIndex = saveData.CurrentSceneIndex;

            Player.ClearAddedStats();
            foreach (var itm in Player.Equipment.GetAll().Where(i => i != null))
            {
                Player.UpdateStats(itm);
            }

            Game = new GameWindow(Player, StoryProgress, Shop);
        }
        public static void Reset()
        {
            Player = null!;
            Game = null!;
            StoryProgress = null!;
            CurrentEnemy = null!;
            IsStoryBattle = false;
            Shop = null!;
            StoryScenes = new List<(string, string)>();
            CurrentSceneIndex = 0;
        }
    }
}
